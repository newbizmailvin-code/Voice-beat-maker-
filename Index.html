<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Voice Beat Maker</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #1a2a6c);
            color: white;
            min-height: 100vh;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 100%;
            width: 100%;
            background: rgba(0, 0, 0, 0.85);
            padding: 20px;
            margin-top: 0;
            min-height: 100vh;
            position: relative;
        }
        
        header {
            text-align: center;
            margin-bottom: 20px;
            padding-top: 10px;
        }
        
        h1 {
            font-size: 1.8rem;
            margin-bottom: 8px;
            background: linear-gradient(to right, #ff8a00, #da1b60);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }
        
        .subtitle {
            font-size: 1rem;
            opacity: 0.9;
            margin-bottom: 15px;
        }
        
        .recording-section {
            background: rgba(30, 30, 50, 0.7);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }
        
        .visualizer {
            height: 120px;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 10px;
            margin: 15px 0;
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .visualizer-bar {
            position: absolute;
            bottom: 0;
            width: 3px;
            background: linear-gradient(to top, #ff8a00, #da1b60);
            border-radius: 2px 2px 0 0;
        }
        
        .controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin: 20px 0;
        }
        
        button {
            padding: 15px 20px;
            font-size: 1.1rem;
            font-weight: 600;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 100%;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        #recordBtn {
            background: linear-gradient(to right, #ff416c, #ff4b2b);
            color: white;
        }
        
        #stopBtn {
            background: linear-gradient(to right, #11998e, #38ef7d);
            color: white;
        }
        
        #playBtn {
            background: linear-gradient(to right, #2193b0, #6dd5ed);
            color: white;
        }
        
        #exportBtn {
            background: linear-gradient(to right, #834d9b, #d04ed6);
            color: white;
        }
        
        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.4);
        }
        
        button:active:not(:disabled) {
            transform: translateY(1px);
        }
        
        .genre-section {
            background: rgba(30, 30, 50, 0.7);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }
        
        h2 {
            font-size: 1.4rem;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .genre-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 15px;
        }
        
        .genre-card {
            background: rgba(50, 50, 80, 0.7);
            border-radius: 12px;
            padding: 15px 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            min-height: 90px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        
        .genre-card:hover {
            transform: translateY(-3px);
            background: rgba(70, 70, 120, 0.8);
        }
        
        .genre-card.selected {
            border-color: #ff8a00;
            background: rgba(90, 90, 150, 0.9);
            box-shadow: 0 0 15px rgba(255, 138, 0, 0.5);
        }
        
        .genre-icon {
            font-size: 1.8rem;
            margin-bottom: 8px;
        }
        
        .genre-name {
            font-size: 0.95rem;
            font-weight: 500;
        }
        
        .status {
            text-align: center;
            padding: 15px;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 10px;
            margin: 15px 0;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            line-height: 1.4;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .export-section {
            background: rgba(30, 30, 50, 0.7);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }
        
        .export-info {
            margin: 15px 0;
            font-size: 1rem;
        }
        
        .progress-container {
            height: 10px;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 5px;
            margin: 20px 0;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(to right, #ff8a00, #da1b60);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .iphone-mic-guide {
            background: rgba(255, 215, 0, 0.15);
            border: 1px solid rgba(255, 215, 0, 0.3);
            border-radius: 12px;
            padding: 15px;
            margin: 20px 0;
            text-align: center;
        }
        
        .mic-icon {
            font-size: 2.5rem;
            margin-bottom: 10px;
            color: #ffd700;
        }
        
        .guide-title {
            font-size: 1.2rem;
            margin-bottom: 10px;
            color: #ffd700;
        }
        
        .guide-steps {
            text-align: left;
            padding: 0 10px;
        }
        
        .guide-steps li {
            margin-bottom: 8px;
            font-size: 0.95rem;
        }
        
        footer {
            margin-top: 20px;
            text-align: center;
            opacity: 0.7;
            font-size: 0.8rem;
            padding: 15px;
        }
        
        .recording-indicator {
            display: none;
            width: 20px;
            height: 20px;
            background: #ff0000;
            border-radius: 50%;
            margin-right: 10px;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.3; }
            100% { opacity: 1; }
        }
        
        .recording .recording-indicator {
            display: block;
        }
        
        @media (max-width: 375px) {
            h1 {
                font-size: 1.6rem;
            }
            
            .genre-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .genre-card {
                padding: 12px 8px;
            }
            
            .genre-name {
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Voice Beat Maker</h1>
            <p class="subtitle">iPhone 8 Optimized | Record & Export MP3</p>
        </header>
        
        <div class="iphone-mic-guide">
            <div class="mic-icon">üé§</div>
            <div class="guide-title">iPhone 8 Microphone Location</div>
            <ul class="guide-steps">
                <li>Your iPhone 8 has 3 microphones</li>
                <li><strong>Bottom mic:</strong> Primary mic for calls/recording</li>
                <li><strong>Front mic:</strong> Near front camera for selfies</li>
                <li><strong>Rear mic:</strong> Near rear camera for videos</li>
                <li><strong>For best results:</strong> Hold phone normally and speak into the bottom</li>
            </ul>
        </div>
        
        <section class="recording-section">
            <h2>Voice Recording</h2>
            <div class="visualizer" id="visualizer"></div>
            
            <div class="controls">
                <button id="recordBtn">
                    <span class="recording-indicator"></span>
                    <span>üé§ Record Voice (5s)</span>
                </button>
                <button id="stopBtn" disabled>
                    <span>‚èπÔ∏è Stop Recording</span>
                </button>
                <button id="playBtn" disabled>
                    <span>‚ñ∂Ô∏è Play Generated Song</span>
                </button>
            </div>
            
            <div class="status" id="status">
                Ready to record. Click "Record Voice" to start.
            </div>
        </section>
        
        <section class="genre-section">
            <h2>Choose Genre</h2>
            <p>Select a genre to generate your beat</p>
            
            <div class="genre-grid" id="genreGrid">
                <!-- Genres will be populated by JavaScript -->
            </div>
        </section>
        
        <section class="export-section">
            <h2>Export Your Song</h2>
            <p class="export-info">Once you've generated a song, you can export it as an MP3 file</p>
            
            <div class="controls">
                <button id="exportBtn" disabled>
                    <span>üíæ Export as MP3</span>
                </button>
            </div>
            
            <div class="progress-container">
                <div class="progress-bar" id="progressBar"></div>
            </div>
        </section>
    </div>
    
    <footer>
        <p>Voice Beat Maker | Optimized for iPhone 8</p>
    </footer>

    <script>
        // Genre data
        const genres = [
            { id: 'pop', name: 'Pop', icon: 'üéµ', tempo: 120, color: '#ff6b6b' },
            { id: 'hiphop', name: 'Hip-Hop', icon: 'üé§', tempo: 85, color: '#4ecdc4' },
            { id: 'edm', name: 'EDM', tempo: 128, color: '#1a936f' },
            { id: 'reggae', name: 'Reggae', icon: 'üå¥', tempo: 90, color: '#ffd166' },
            { id: 'rock', name: 'Rock', icon: 'üé∏', tempo: 110, color: '#ef476f' },
            { id: 'jazz', name: 'Jazz', icon: 'üé∑', tempo: 95, color: '#118ab2' },
            { id: 'lofi', name: 'Lo-Fi', icon: '‚òï', tempo: 80, color: '#073b4c' },
            { id: 'trap', name: 'Trap', icon: 'üî•', tempo: 140, color: '#06d6a0' },
            { id: 'country', name: 'Country', icon: 'ü§†', tempo: 100, color: '#ff9e00' },
            { id: 'funk', name: 'Funk', icon: 'üï∫', tempo: 115, color: '#7209b7' }
        ];
        
        // DOM Elements
        const recordBtn = document.getElementById('recordBtn');
        const stopBtn = document.getElementById('stopBtn');
        const playBtn = document.getElementById('playBtn');
        const exportBtn = document.getElementById('exportBtn');
        const statusEl = document.getElementById('status');
        const genreGrid = document.getElementById('genreGrid');
        const visualizer = document.getElementById('visualizer');
        const progressBar = document.getElementById('progressBar');
        const recordingIndicator = document.querySelector('.recording-indicator');
        
        // State variables
        let mediaRecorder;
        let audioChunks = [];
        let selectedGenre = 'pop';
        let isRecording = false;
        let generatedSong = null;
        let audioContext;
        let analyser;
        let dataArray;
        let animationId;
        
        // Initialize genre grid
        function initGenreGrid() {
            genreGrid.innerHTML = '';
            genres.forEach(genre => {
                const card = document.createElement('div');
                card.className = 'genre-card';
                card.dataset.genre = genre.id;
                if (genre.id === selectedGenre) {
                    card.classList.add('selected');
                }
                
                card.innerHTML = `
                    <div class="genre-icon">${genre.icon || 'üéµ'}</div>
                    <div class="genre-name">${genre.name}</div>
                `;
                
                card.addEventListener('click', () => {
                    document.querySelectorAll('.genre-card').forEach(c => c.classList.remove('selected'));
                    card.classList.add('selected');
                    selectedGenre = genre.id;
                    statusEl.textContent = `Genre selected: ${genre.name}`;
                });
                
                genreGrid.appendChild(card);
            });
        }
        
        // Create visualizer bars
        function createVisualizer() {
            visualizer.innerHTML = '';
            const barCount = 48;
            for (let i = 0; i < barCount; i++) {
                const bar = document.createElement('div');
                bar.className = 'visualizer-bar';
                bar.style.left = `${(i / barCount) * 100}%`;
                bar.style.height = '0%';
                visualizer.appendChild(bar);
            }
        }
        
        // Update visualizer
        function updateVisualizer() {
            if (!analyser || !dataArray) return;
            
            analyser.getByteFrequencyData(dataArray);
            const bars = document.querySelectorAll('.visualizer-bar');
            
            bars.forEach((bar, i) => {
                const value = dataArray[i] / 255;
                const height = Math.max(5, value * 100);
                bar.style.height = `${height}%`;
            });
            
            animationId = requestAnimationFrame(updateVisualizer);
        }
        
        // Start recording
        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        sampleRate: 44100
                    } 
                });
                
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                
                mediaRecorder.ondataavailable = event => {
                    audioChunks.push(event.data);
                };
                
                mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                    statusEl.textContent = 'Recording complete! Processing your voice...';
                    
                    // Create audio context for visualization
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    analyser = audioContext.createAnalyser();
                    const source = audioContext.createMediaStreamSource(stream);
                    source.connect(analyser);
                    analyser.fftSize = 128;
                    dataArray = new Uint8Array(analyser.frequencyBinCount);
                    
                    // Start visualization
                    updateVisualizer();
                    
                    // Stop all tracks
                    stream.getTracks().forEach(track => track.stop());
                    
                    // Enable play button
                    playBtn.disabled = false;
                    statusEl.textContent = 'Voice recorded! Select a genre and click "Play Generated Song"';
                };
                
                mediaRecorder.start();
                isRecording = true;
                recordBtn.disabled = true;
                stopBtn.disabled = false;
                recordBtn.classList.add('recording');
                statusEl.textContent = 'Recording... Speak or hum for 5 seconds';
                
                // Auto stop after 5 seconds
                setTimeout(() => {
                    if (isRecording) {
                        stopRecording();
                    }
                }, 5000);
                
            } catch (err) {
                console.error('Error accessing microphone:', err);
                statusEl.textContent = 'Error accessing microphone. Please check permissions.';
                recordBtn.classList.remove('recording');
            }
        }
        
        // Stop recording
        function stopRecording() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                isRecording = false;
                stopBtn.disabled = true;
                recordBtn.disabled = false;
                recordBtn.classList.remove('recording');
            }
        }
        
        // Play generated song
        function playGeneratedSong() {
            // Stop any existing playback
            Tone.Transport.stop();
            Tone.Transport.cancel();
            
            // Get selected genre
            const genre = genres.find(g => g.id === selectedGenre);
            if (!genre) return;
            
            // Set tempo
            Tone.Transport.bpm.value = genre.tempo;
            
            // Create instruments
            const synth = new Tone.PolySynth(Tone.Synth).toDestination();
            const drum = new Tone.MembraneSynth().toDestination();
            const bass = new Tone.MonoSynth().toDestination();
            
            // Create chord progression based on genre
            const chords = getChordProgression(genre.id);
            const chordSeq = new Tone.Sequence((time, chord) => {
                synth.triggerAttackRelease(chord, "2n", time);
            }, chords, "4n");
            
            // Create drum pattern
            const drumPattern = getDrumPattern(genre.id);
            const drumSeq = new Tone.Sequence((time, note) => {
                if (note) {
                    drum.triggerAttackRelease(note, "8n", time);
                }
            }, drumPattern, "4n");
            
            // Create bass line
            const bassNotes = getBassLine(genre.id);
            const bassSeq = new Tone.Sequence((time, note) => {
                if (note) {
                    bass.triggerAttackRelease(note, "4n", time);
                }
            }, bassNotes, "4n");
            
            // Start sequences
            chordSeq.start(0);
            drumSeq.start(0);
            bassSeq.start(0);
            
            // Start transport
            Tone.Transport.start();
            
            statusEl.textContent = `Playing ${genre.name} song! Click "Export as MP3" to save your creation.`;
            exportBtn.disabled = false;
            generatedSong = { synth, drum, bass, chordSeq, drumSeq, bassSeq };
        }
        
        // Export as MP3
        function exportAsMP3() {
            statusEl.textContent = 'Exporting as MP3... Please wait';
            progressBar.style.width = '0%';
            exportBtn.disabled = true;
            
            // Create a new recording destination
            const recorder = new Tone.Recorder();
            const synth = new Tone.PolySynth(Tone.Synth).connect(recorder);
            const drum = new Tone.MembraneSynth().connect(recorder);
            const bass = new Tone.MonoSynth().connect(recorder);
            
            // Get genre
            const genre = genres.find(g => g.id === selectedGenre);
            Tone.Transport.bpm.value = genre.tempo;
            
            // Create sequences
            const chords = getChordProgression(genre.id);
            const chordSeq = new Tone.Sequence((time, chord) => {
                synth.triggerAttackRelease(chord, "2n", time);
            }, chords, "4n");
            
            const drumPattern = getDrumPattern(genre.id);
            const drumSeq = new Tone.Sequence((time, note) => {
                if (note) {
                    drum.triggerAttackRelease(note, "8n", time);
                }
            }, drumPattern, "4n");
            
            const bassNotes = getBassLine(genre.id);
            const bassSeq = new Tone.Sequence((time, note) => {
                if (note) {
                    bass.triggerAttackRelease(note, "4n", time);
                }
            }, bassNotes, "4n");
            
            // Start recording
            recorder.start();
            
            // Start sequences
            chordSeq.start(0);
            drumSeq.start(0);
            bassSeq.start(0);
            
            // Schedule stop after 16 bars (4 measures)
            Tone.Transport.scheduleOnce(() => {
                chordSeq.stop();
                drumSeq.stop();
                bassSeq.stop();
                
                // Stop recording after a small delay
                setTimeout(async () => {
                    const recording = await recorder.stop();
                    recorder.dispose();
                    synth.dispose();
                    drum.dispose();
                    bass.dispose();
                    
                    // Create download link
                    const url = URL.createObjectURL(recording);
                    const a = document.createElement("a");
                    a.href = url;
                    a.download = `voice-beat-${genre.name}-${Date.now()}.mp3`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    
                    statusEl.textContent = 'MP3 exported successfully!';
                    exportBtn.disabled = false;
                }, 500);
            }, "4m");
            
            // Start transport
            Tone.Transport.start();
            
            // Update progress bar
            let progress = 0;
            const interval = setInterval(() => {
                progress += 2;
                progressBar.style.width = `${progress}%`;
                if (progress >= 100) {
                    clearInterval(interval);
                }
            }, 100);
        }
        
        // Helper functions for music generation
        function getChordProgression(genre) {
            switch(genre) {
                case 'pop': return ['C4', 'G4', 'Am4', 'F4'];
                case 'hiphop': return ['Dm4', 'G4', 'C4', 'Bb4'];
                case 'edm': return ['C3', 'G3', 'A3', 'F3'];
                case 'reggae': return ['F4', 'Bb4', 'C4', 'Dm4'];
                case 'rock': return ['E4', 'B4', 'A4', 'C#m4'];
                case 'jazz': return ['Dm7', 'G7', 'Cmaj7', 'Em7'];
                case 'lofi': return ['Fmaj7', 'Gm7', 'C7', 'Dm7'];
                case 'trap': return ['C#m', 'F#m', 'A', 'E'];
                case 'country': return ['G4', 'D4', 'Em4', 'C4'];
                case 'funk': return ['C3', 'F3', 'G3', 'Eb3'];
                default: return ['C4', 'G4', 'Am4', 'F4'];
            }
        }
        
        function getDrumPattern(genre) {
            switch(genre) {
                case 'pop': return ['C2', null, 'C2', 'C2'];
                case 'hiphop': return ['C2', null, 'C2', null];
                case 'edm': return ['C2', 'C2', 'C2', 'C2'];
                case 'reggae': return [null, 'C2', null, 'C2'];
                case 'rock': return ['C2', null, 'C2', 'C2'];
                case 'jazz': return ['C2', null, 'C2', null];
                case 'lofi': return ['C2', null, 'C2', null];
                case 'trap': return ['C2', 'C2', 'C2', 'C2'];
                case 'country': return ['C2', null, 'C2', null];
                case 'funk': return ['C2', null, 'C2', 'C2'];
                default: return ['C2', null, 'C2', 'C2'];
            }
        }
        
        function getBassLine(genre) {
            switch(genre) {
                case 'pop': return ['C2', 'G2', 'A2', 'F2'];
                case 'hiphop': return ['D2', 'G2', 'C2', 'Bb2'];
                case 'edm': return ['C2', 'G2', 'A2', 'F2'];
                case 'reggae': return ['F2', 'Bb2', 'C2', 'D2'];
                case 'rock': return ['E2', 'B2', 'A2', 'C#2'];
                case 'jazz': return ['D2', 'G2', 'C2', 'E2'];
                case 'lofi': return ['F2', 'G2', 'C2', 'D2'];
                case 'trap': return ['C#2', 'F#2', 'A2', 'E2'];
                case 'country': return ['G2', 'D2', 'E2', 'C2'];
                case 'funk': return ['C2', 'F2', 'G2', 'Eb2'];
                default: return ['C2', 'G2', 'A2', 'F2'];
            }
        }
        
        // Event listeners
        recordBtn.addEventListener('click', startRecording);
        stopBtn.addEventListener('click', stopRecording);
        playBtn.addEventListener('click', playGeneratedSong);
        exportBtn.addEventListener('click', exportAsMP3);
        
        // Initialize
        initGenreGrid();
        createVisualizer();
        
        // Clean up on unload
        window.addEventListener('beforeunload', () => {
            if (animationId) {
                cancelAnimationFrame(animationId);
            }
            if (audioContext) {
                audioContext.close();
            }
        });
        
        // Handle iOS audio context
        document.addEventListener('touchstart', function() {
            if (audioContext && audioContext.state === 'suspended') {
                audioContext.resume();
            }
        }, { once: true });
    </script>
</body>
</html>
